name: Data Quality Pipeline
on:
  schedule:
    - cron: '0 2 * * *'  # Run daily at 2 AM UTC
  workflow_dispatch:

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Run Great Expectations tests
      run: |
        echo "üîç Running data quality validations..."
        
        # Install Great Expectations if you have it
        # pip install great_expectations
        
        # Run your data quality scripts
        echo "Testing data completeness..."
        python -c "
        import duckdb
        conn = duckdb.connect('finance_data.db')
        count = conn.execute('SELECT COUNT(*) FROM warehouse_transactions').fetchone()[0]
        print(f'Total transactions: {count}')
        assert count > 0, 'No data found!'
        "
        
        echo "‚úÖ Basic quality checks passed"
        
    - name: Generate Quality Report
      run: |
        echo "üìä Generating quality report..."
        
        # Create quality report
        mkdir -p quality-reports
        echo "Quality Report - $(date)" > quality-reports/report_$(date +%Y%m%d).txt
        echo "======================" >> quality-reports/report_$(date +%Y%m%d).txt
        
        # Add basic metrics
        python -c "
        import duckdb
        import pandas as pd
        conn = duckdb.connect('finance_data.db')
        
        metrics = {
            'total_transactions': conn.execute('SELECT COUNT(*) FROM warehouse_transactions').fetchone()[0],
            'unique_accounts': conn.execute('SELECT COUNT(DISTINCT account_id) FROM warehouse_transactions').fetchone()[0],
            'date_range': conn.execute('SELECT MIN(date_key), MAX(date_key) FROM warehouse_transactions').fetchone(),
            'null_values': conn.execute(\"SELECT COUNT(*) FROM warehouse_transactions WHERE amount IS NULL\").fetchone()[0]
        }
        
        with open('quality-reports/report_$(date +%Y%m%d).txt', 'a') as f:
            for key, value in metrics.items():
                f.write(f'{key}: {value}\\n')
        "
        
        echo "Report saved to quality-reports/"
        
    - name: Upload Quality Report
      uses: actions/upload-artifact@v3
      with:
        name: quality-report-$(date +%Y%m%d)
        path: quality-reports/
        
  notify-quality:
    runs-on: ubuntu-latest
    needs: quality-checks
    if: always()
    
    steps:
    - name: Quality Status
      run: |
        echo "üìà Data Quality Pipeline Results:"
        echo "Job status: ${{ needs.quality-checks.result }}"
        echo "Run date: $(date)"
        
        if [ "${{ needs.quality-checks.result }}" == "success" ]; then
          echo "‚úÖ All quality checks passed!"
        else
          echo "‚ùå Quality checks failed! Check the logs."
        fi
