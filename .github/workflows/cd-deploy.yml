name: CD Pipeline - Deployment
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-airflow:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to Local Environment
      run: |
        echo "üöÄ Deploying Finance Data Pipeline..."
        
        # Stop existing containers
        cd airflow && docker-compose down || true
        
        # Pull latest changes
        git pull origin main
        
        # Start services
        docker-compose up -d
        
        # Wait for services to be ready
        sleep 45
        
        # Verify deployment
        echo "‚úÖ Checking deployed services:"
        docker-compose ps
        
        echo "üåê Airflow UI: http://localhost:8080"
        echo "üìä Airflow API: http://localhost:8080/api/v1/health"
        
    - name: Run Data Pipeline
      run: |
        echo "üìà Running initial data pipeline..."
        cd airflow
        
        # Trigger daily DAG
        docker-compose exec airflow-webserver airflow dags trigger finance_daily_processing || echo "Trigger failed, DAG may be paused"
        
        # Wait for completion
        sleep 60
        
        # Check DAG status
        docker-compose exec airflow-webserver airflow dags list
        
    - name: Verify Data Quality
      run: |
        echo "üîç Running data quality checks..."
        cd airflow
        
        # Trigger quality DAG
        docker-compose exec airflow-webserver airflow dags trigger finance_data_quality || echo "Trigger failed, DAG may be paused"
        
        # Check for any errors
        docker-compose logs --tail=50 airflow-scheduler
        
    - name: Health Check
      run: |
        echo "üè• Performing health checks..."
        
        # Check if Airflow is responding
        curl -f http://localhost:8080/health || echo "Airflow health check failed"
        
        # Check if database is accessible
        docker exec airflow_postgres_1 pg_isready -U airflow || echo "PostgreSQL check failed"
        
        echo "‚úÖ Deployment completed successfully!"
        
  notify-deployment:
    runs-on: ubuntu-latest
    needs: deploy-airflow
    if: always()
    
    steps:
    - name: Deployment Status
      run: |
        echo "üìä Deployment Summary:"
        echo "Status: ${{ needs.deploy-airflow.result }}"
        echo "Time: $(date)"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        
        if [ "${{ needs.deploy-airflow.result }}" == "success" ]; then
          echo "üéâ Deployment successful!"
          echo "Access your services at:"
          echo "- Airflow UI: http://localhost:8080"
          echo "- Database: localhost:5432"
        else
          echo "‚ùå Deployment failed!"
          echo "Check logs for details."
        fi
