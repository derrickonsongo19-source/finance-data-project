name: CI Pipeline - Finance Data Project
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run Python tests
      run: |
        python -m pytest tests/ -v
        
    - name: Check code formatting with black
      run: |
        pip install black
        black --check .
        
    - name: Lint with flake8
      run: |
        pip install flake8
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: Verify Airflow DAGs
      run: |
        pip install apache-airflow
        python -m pytest airflow/dags/ -v
        
    - name: Validate data pipeline scripts
      run: |
        echo "âœ… Checking Python scripts syntax..."
        python -m py_compile *.py
        
  docker-build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker images
      run: |
        echo "Building Airflow Docker image..."
        cd airflow
        docker-compose build
        
    - name: Run Docker containers
      run: |
        cd airflow
        docker-compose up -d
        sleep 30
        
    - name: Verify Airflow services
      run: |
        cd airflow
        docker-compose ps | grep -E "(healthy|Up)"
        
    - name: Cleanup
      if: always()
      run: |
        cd airflow
        docker-compose down
        
  data-pipeline:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Run data pipeline
      run: |
        echo "ðŸš€ Testing data pipeline components..."
        
        # Test bronze layer
        python bronze_layer.py --test
        
        # Test silver layer  
        python silver_layer.py --test
        
        # Test gold layer
        python gold_layer.py --test
        
        echo "âœ… Data pipeline tests completed"
        
  notify:
    runs-on: ubuntu-latest
    needs: [test, docker-build, data-pipeline]
    if: always()
    
    steps:
    - name: CI Status
      run: |
        echo "ðŸŽ‰ CI Pipeline Status:"
        echo "Test job: ${{ needs.test.result }}"
        echo "Docker build: ${{ needs.docker-build.result }}"
        echo "Data pipeline: ${{ needs.data-pipeline.result }}"
